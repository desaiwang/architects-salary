<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1" />

<head>
  <!-- Basic Meta Tags -->
  <meta charset="UTF-8">
  <meta name="description"
    content="Interactive visualizations of architect income data. Explore salary trends, job satisfaction, and more.">
  <meta name="keywords" content="Architect salaries, income visualization, architecture industry data">
  <meta name="author" content="Desai Wang">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index, follow">
  <meta name="description"
    content="Using over 13,000 survey responses from Archinect.com, I visualized the relationships between between pay, gender, location, licensure, and job satisfaction in architecture." />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DZZ2ZKLBV7"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-DZZ2ZKLBV7');
  </script>

  <!-- Social Media Meta Tags -->
  <!-- Open Graph (OG) Tags -->
  <meta property="og:title" content="Architect's Salary">
  <meta property="og:description"
    content="Interactive visualizations of architects' incomes, satisfaction, and demographic data.">
  <meta property="og:image" content="https://desaiwang.github.io/architects-salary/site_capsule.jpg">
  <meta property="og:url" content="https://desaiwang.github.io/architects-salary/">
  <meta property="og:type" content="website">

  <!-- Twitter Card Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Architect's Salary">
  <meta name="twitter:description"
    content="Interactive visualizations of architects' incomes, satisfaction, and demographic data.">
  <meta name="twitter:image" content="https://desaiwang.github.io/architects-salary/site_capsule.jpg">


  <title>Architect's Salary</title>

  <link rel="icon" type="image/svg+xml" href="/desai_icon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet" />
  <link href="./style.css" rel="stylesheet" type="text/css" />
  <link href="./header-style.css" rel="stylesheet" type="text/css" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/d3-tile@1"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/d3-hexbin@0.2"></script>
</head>

<body>
  <div class="headingContainer">
    <!-- Header Section -->
    <header>
      <!-- Logo -->
      <div class="logo">
        <a href="https://desaiwang.github.io">Desai Wang</a>
      </div>

      <!-- Desktop Navigation -->
      <nav class="navigation desktop">
        <a href="https://desaiwang.com">work</a>
        <a href="/#/everything-I-ate-in-Singapore">play</a>
        <a href="https://desaiwang.com/blog">blog</a>
      </nav>

      <!-- Mobile Menu Button -->
      <div class="menu-button" onclick="toggleMenu()">â˜°</div>

      <!-- Mobile Navigation -->
      <nav id="mobile-menu" class="menu-mobile hidden">
        <a href="https://desaiwang.com">work</a>
        <a href="/#/everything-I-ate-in-Singapore">play</a>
        <a href="/#/blog">blog</a>
      </nav>
    </header>

    <div class="heading">
      <!-- Heading Text Section -->
      <section class="headingText">
        <h1>How much do architects really make in the US?</h1>
        <p>Using over 13,000 survey responses from <a class="removeUnderline" href="https://salaries.archinect.com/">
            Archinect.com</a>, I visualized the relationships between pay, gender, location, licensure, and job
          satisfaction in architecture.</p>
        <p>My hope is that by sharing this data, we can drive pay transparency and strive for a fairer future for
          architects.</p>
      </section>

      <!-- Heading Text Section -->
      <div class="scrollArrow" style="align-self: flex-end;">
        <a href="#visualization" class="scroll-link">go to visualization<svg xmlns="http://www.w3.org/2000/svg"
            fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" width="50" height="50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25 12 21m0 0-3.75-3.75M12 21V3" />
          </svg>
        </a>
      </div>
    </div>
  </div>

  <div id="visualization" style="display: flex">
    <div class="main min-height-view" id="mainContainer">
      <div class="summaryContainer">
        <div class="emptySummary" style="display: none; margin-left: 1.5rem">
          <h2>No data selected.</h2>
        </div>
        <div class="summaryAll" style="
                display: flex;
                column-gap: 2rem;
                margin-left: 1.5rem;
                vertical-align: bottom;
              ">
          <div class="summary" id="medianSalary">
            <h2 id="medianSalary"></h2>
            <p>median salary</p>
          </div>
          <div class="summary">
            <h2 id="meanSatisfaction"></h2>
            <p>mean satisfaction</p>
          </div>
          <div class="summary">
            <h2 id="numResponses"></h2>
            <p id="numResponsesTotal"></p>
          </div>
        </div>
      </div>

      <div id="canvasContainer" style="position: relative;"></div>

      <div id="hexbinMap"
        style="position: relative; display:none; justify-content: center; align-items: center; flex: 1 1 auto"></div>

    </div>

    <div class="aside" style="overflow-y: scroll; overflow-x: hidden; z-index: 10">
      <div id="sidebarCollapseDiv" style="position: sticky; top: 0; z-index: 20">
        <div style="padding: 0.5rem 0">
          <button id="sidebarcollapse" class="collapse title">
            <i class="bx bx-chevron-right"></i>
            <span>Collapse</span>
          </button>
        </div>
      </div>

      <div id="toggleIndMapContainer">
        <button id="toggleIndMap" class="collapse title" style="padding-top:0; white-space: nowrap;">
          <svg width="17" height="12" xmlns="http://www.w3.org/2000/svg">
            <!-- Circle -->
            <circle id="toggleCircle" cx="10" cy="5.5" r="4" stroke="currentColor" stroke-width="1.25" fill="none"
              style="display:none;" />
            <!-- Hexagon -->
            <polygon id="toggleHexagon" points="0,4 -3.464,2 -3.464,-2 0,-4 3.464,-2 3.464,2" stroke="currentColor"
              stroke-width="1.25" fill="none" style="transform: translate(10px,5.5px) scale(110%)" />
          </svg>
          <span style="margin-left:3px">View Map</span>
        </button>
      </div>

      <div class="sidebar" style="display: flex; flex-direction: column; width: 305">
        <div id="filtersContainer">
          <div style="display: flex; justify-content: space-between">
            <button class="collapse filters title">
              <i class="bx bx-chevron-right"></i>
              <span>Filter</span>
            </button>
            <div style="padding: 0.625rem 0 0.125rem 0">
              <button class="clear-all-filters" style="visibility: hidden">
                <i class="bx bx-x"></i>
                <span>clear all filters</span>
              </button>
            </div>
          </div>

          <div class="filters" style="margin-left: 1rem">
            <div id="controlfilterSalary" class="filter"></div>
            <div id="controlfilterSatisfaction" class="filter"></div>
            <div id="searchLocation" class="filter"></div>
            <div id="controlfilterGender"></div>

            <div id="controlfilterAge" class="filter"></div>
            <div id="controlfilterYearsOfExperience" class="filter"></div>
            <div id="controlfilterLicensed"></div>

            <div id="controlfilterFirmType" class="filter"></div>
            <div id="controlfilterFirmSize" class="filter"></div>
            <div id="searchJobTitle"></div>
            <div id="searchJobTitle"></div>

            <div id="searchUG" class="filter"></div>
            <div id="searchGrad" class="filter"></div>

            <div id="controlfilterTime" class="filter"></div>
          </div>
        </div>

        <div id="customizeContainer">
          <button class="collapse customize title">
            <i class="bx bx-chevron-right"></i>
            <span>Customize</span>
          </button>

          <div class="customize" style="
                  display: flex;
                  flex-direction: column;
                  row-gap: 0.5rem;
                  margin: 0.5rem 0 0.25rem 1rem;
                  display: none;
                ">
            <div class="customizeDropdown indMapCustomize">
              <span class="title" style="font-size: 0.8rem">color by:</span>
              <div class="colorScale" style="margin-left: 1.25rem">
                <select class="colorScale" style="width: 180">
                  <option value="Job Satisfaction" selected>
                    Job Satisfaction
                  </option>
                  <option value="Gender">Gender</option>
                  <option value="Age">Age</option>
                  <option value="Years of Experience">
                    Years of Experience
                  </option>
                  <option value="Licensed">Licensed</option>
                  <option value="Firm Type">Firm Type</option>
                  <option value="Firm Size">Firm Size</option>
                  <option value="Year">Year</option>
                </select>
              </div>
            </div>

            <div class="customizeDropdown indMapCustomize">
              <span class="title" style="font-size: 0.8rem">sort by:</span>
              <div class="sortOrder" style="margin-left: 1.25rem">
                <select class="sortOrder" style="width: 180">
                  <option value="Year" selected>Year</option>
                  <option value="Salary">Salary</option>
                  <option value="Job Satisfaction">Job Satisfaction</option>
                  <option value="Gender">Gender</option>
                  <option value="Age">Age</option>
                  <option value="Years of Experience">
                    Years of Experience
                  </option>
                  <option value="Licensed">Licensed</option>
                  <option value="Firm Type">Firm Type</option>
                  <option value="Firm Size">Firm Size</option>
                </select>
              </div>
            </div>

            <div class="customizeDropdown hexbinCustomize" style="display:none">
              <span class="title" style="font-size: 0.8rem">color by:</span>
              <div class="colorScaleHexbin" style="margin-left: 1.25rem">
                <select class="colorScaleHexbin" style="width: 180">
                  <option value="Job Satisfaction" selected>
                    Mean Job Satisfaction
                  </option>
                  <option value="Salary">
                    Median Salary
                  </option>
                  <option value="percentageFemale">% Female</option>
                  <option value="percentageLicensed">% Licensed</option>
                  <option value="firmTypeMode">Most Common Firm Type</option>
                  <option value="firmSizeMode">Most Common Firm Size</option>
                </select>
              </div>
            </div>

            <div class="customizeDropdown hexbinCustomize" style="display:none">
              <span class="title" style="font-size: 0.8rem">size by:</span>
              <div class="sizeScaleHexbin" style="margin-left: 1.25rem">
                <select class="sizeScaleHexbin" style="width: 180">
                  <option value="length" selected>
                    Number of Responses
                  </option>
                  <option value="Job Satisfaction">
                    Mean Job Satisfaction
                  </option>
                  <option value="Salary">
                    Median Salary
                  </option>
                  <option value="percentageFemale">% Female</option>
                  <option value="percentageLicensed">% Licensed</option>
                </select>
              </div>
            </div>

          </div>
        </div>

        <div id="collapsibleLegend" style="padding-bottom: 16px"></div>
      </div>
    </div>
  </div>




  </div>
  </div>

  <script>
    //for mobile menu toggles
    const toggleMenu = () => {
      const menu = document.getElementById('mobile-menu');
      if (menu.classList.contains('hidden')) {
        menu.classList.remove('hidden');
      } else {
        menu.classList.add('hidden');
      }
    };
  </script>

  <script type="module">
    import { geoAlbersUsaPr } from "./js/geoAlbersUsaPr.js";
    import ClickableHistogramSlider from "./js/clickableHistogramSlider.js";
    import CurveSlider from "./js/curveSlider.js";
    import IndividualMap from "./js/individualMap.js";
    import HexbinMap from "./js/hexbinMap.js";
    import SearchBar from "./js/searchBar.js";
    import Checkboxes from "./js/checkboxes.js";
    import CollapsibleLegend from "./js/CollapsibleLegend.js";
    import { sortOrders } from "./js/sortOrders.js";
    import { Legend } from "./js/legend.js";


    const loadIndividuals = async function () {
      let data = await d3.csv(
        "data/241209_archinect_salaries_fulltime.csv",
        d3.autoType
      );
      //console.log(data);
      data.forEach((d) => {
        if (d["Firm Type"] == null) {
          d["Firm Type"] = "N/A";
        }
      });
      //save passingData outside
      let passingData = data;

      //filter used for updates
      var filters = {};

      function pointPassesFilters(point) {
        let stillPassed = true;

        Object.values(filters).forEach((filterFunc) => {
          stillPassed = filterFunc(point) && stillPassed;
        });

        return stillPassed;
      }

      //sets up controls
      let controlWidth = 270;
      let controlHeight = 60;

      let controlSalary = d3.select("#controlfilterSalary");
      let salarySlider = new CurveSlider(
        data,
        controlSalary,
        "Salary",
        "Inflation Adjusted Salary",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          maxLimit: 200000,
          scaleFormatter: (d) => (d === 0 ? "$0" : d3.format("$.2s")(d)),
        }
      );

      //add toggle for inflation
      d3.select("div.slider-rowwrapper").append("div").html(`<div id="toggleInflation" style="padding: 0.25rem 0 0.5rem 0.5rem">
            <label class= "switch">
                    <input type="checkbox" id="toggleSwitch" checked>
                  <span class="slider round"></span>
            </label>
                <span id="toggleLabel">Inflation-Adjusted</span>
            </div>`);

      let adjustInflation = true;

      d3.select("#toggleSwitch").on("change", function () {
        adjustInflation = !adjustInflation;
        //update toggle label
        d3.select("#toggleLabel").text(adjustInflation ? "Inflation-Adjusted" : "Unadjusted");

        //update attribute in salary slider (this will adjust filters and rerender the histogram)
        salarySlider.toggleInflation(adjustInflation ? "Inflation Adjusted Salary" : "Salary");

        //immediately update passing data since filters changed
        passingData = data.filter(pointPassesFilters);

        if (showIndMap) {
          //update salary attribute used in indMap (this will automatically rerender the circles with correct size)
          individualMap.toggleInflation(adjustInflation);

        } else {
          //update salary attribute used in hexbinMap
          hexbinMap.toggleInflation(adjustInflation); //set the correct color and size scales/attributes if necessary
          hexbinMap.updateData(passingData); //update data and rerender

          //update the legends
          updateHexBinSizeScaleNode();
          legend.updateSizeScaleHex(sizeScaleHexbinTitle, hexBinSizeScaleNode);
          updateColorScaleHexbin(colorScaleHexbinAttribute);
        }


        //also resort if sorting is by salary
        if (d3.select("select.sortOrder").node().value == "Salary") {
          individualMap.updateSortOrder(adjustInflation ? "Inflation Adjusted Salary" : "Salary");
        }

        //update summary texts
        updateSummary();
      });


      // let greens = ['#f7fcf5', '#e5f5e0', '#c7e9c0', '#a1d99b', '#74c476', '#41ab5d', '#238b45', '#006d2c', '#00441b']
      const GnColorInterpolator = d3.interpolateRgb("#e5f5e0", "#00441b");
      let controlTime = d3.select("#controlfilterTime");
      const timeSlider = new ClickableHistogramSlider(
        data,
        controlTime,
        "Survey Year",
        "Year",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolator: GnColorInterpolator,
          colorInterpolationType: "sequential discrete",
          fontsize: "0.5rem",
          initiateCollapsed: true,
        }
      );

      let controlSatisfaction = d3.select("#controlfilterSatisfaction");
      const BuOrColorInterpolator = d3.piecewise(d3.interpolateRgb, [
        "#0a1869",
        "#a9c9e7",
        "#ffe3a8",
        "#fc6f03",
      ]);
      const satisfactionSlider = new ClickableHistogramSlider(
        data,
        controlSatisfaction,
        "Job Satisfaction",
        "Job Satisfaction",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolator: BuOrColorInterpolator,
          colorInterpolationType: "sequential continuous",
        }
      );

      // let antiqueColors = ['#428ED9','#A5B845',  '#E5594B', '#F7AB3B','#EABDD1', '#625252']
      let observable10 = [
        "#6cc5b0",
        "#4269d0",
        "#ff8ab7",
        "#efb118",
        "#3ca951",
        "#ff725c",
        "#a463f2",
        "#97bbf5",
        "#9c6b4e",
        "#9498a0",
      ];
      let controlFirmType = d3.select("#controlfilterFirmType");
      const firmtypeSlider = new ClickableHistogramSlider(
        data,
        controlFirmType,
        "Firm Type",
        "Firm Type",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolationType: "categorical",
          colorScheme: observable10,
          sortOrder: sortOrders["Firm Type"],
          fontsize: "0.5rem",
          initiateCollapsed: true,
        }
      );

      //let blues = ['#f7fbff', '#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#08519c', '#08306b']
      let controlFirmSize = d3.select("#controlfilterFirmSize");
      const BuColorInterpolator = d3.interpolateRgb("#deebf7", "#08306b");
      const firmsizeSlider = new ClickableHistogramSlider(
        data,
        controlFirmSize,
        "Firm Size",
        "Firm Size",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolator: BuColorInterpolator,
          colorInterpolationType: "sequential discrete",
          sortOrder: sortOrders["Firm Size"],
          rotateAxisLabels: true,
          initiateCollapsed: true,
        }
      );

      // let purples = ['#fcfbfd', '#efedf5', '#dadaeb', '#bcbddc', '#9e9ac8', '#807dba', '#6a51a3', '#54278f', '#3f007d']
      const PuColorInterpolator = d3.interpolateRgb("#efedf5", "#3f007d");
      let controlAge = d3.select("#controlfilterAge");
      const ageSlider = new ClickableHistogramSlider(
        data,
        controlAge,
        "Age",
        "Age",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolator: PuColorInterpolator,
          colorInterpolationType: "sequential discrete",
          sortOrder: sortOrders["Age"],
          rotateAxisLabels: true,
          initiateCollapsed: true,
        }
      );

      let controlYearsOfExperience = d3.select(
        "#controlfilterYearsOfExperience"
      );
      const yearsOfExperienceSlider = new ClickableHistogramSlider(
        data,
        controlYearsOfExperience,
        "Years of Experience",
        "Years of Experience",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolator: d3.interpolatePuRd,
          colorInterpolationType: "sequential discrete",
          sortOrder: sortOrders["Years of Experience"],
          rotateAxisLabels: true,
          initiateCollapsed: true,
        }
      );

      const firmTypeScale = d3
        .scaleOrdinal()
        .domain([
          "Boutique",
          "Corporate",
          "Individual",
          "Starchitect",
          "Other",
          "N/A",
        ])
        .range(d3.schemeTableau10);

      let controlLicensed = d3.select("#controlfilterLicensed");
      const licensedSlider = new ClickableHistogramSlider(
        data,
        controlLicensed,
        "Licensed",
        "Licensed",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolationType: "categorical",
          colorScheme: ["#4269d0", "#97bbf5"],
          sortOrder: sortOrders["Licensed"],
          initiateCollapsed: true,
        }
      );

      let controlGender = d3.select("#controlfilterGender");
      const genderSlider = new ClickableHistogramSlider(
        data,
        controlGender,
        "Gender",
        "Gender",
        controlWidth,
        controlHeight,
        updateData,
        filters,
        {
          colorInterpolationType: "categorical",
          colorScheme: ["#ff8ab7", "#3ca951", "#efb118"],
          sortOrder: sortOrders["Gender"],
          initiateCollapsed: true,
        }
      );

      //search bars
      let searchJobTitle = d3.select("div#searchJobTitle");
      const jobTitleSearchBar = new SearchBar(
        searchJobTitle,
        "Job Title",
        data,
        filters,
        updateData,
        { placeholderText: "eg. Designer", initiateCollapsed: true }
      );

      let searchLocation = d3.select("div#searchLocation");
      const locationSearchBar = new SearchBar(
        searchLocation,
        "Location",
        data,
        filters,
        updateData,
        { placeholderText: "eg. New York, NY", initiateCollapsed: true }
      );

      let searchUG = d3.select("div#searchUG");
      const ugSearchBar = new SearchBar(
        searchUG,
        "Undergraduate School",
        data,
        filters,
        updateData,
        { placeholderText: "eg. Cornell University", initiateCollapsed: true }
      );

      let searchGrad = d3.select("div#searchGrad");
      const gradSearchBar = new SearchBar(
        searchGrad,
        "Graduate School",
        data,
        filters,
        updateData,
        {
          placeholderText: "eg. University of Washington",
          initiateCollapsed: true,
        }
      );

      //scales
      const salaryExtent = d3.extent(data, (d) => d["Salary"]);
      const salaryScale = d3
        .scaleSqrt()
        .domain(salaryExtent)
        .range([0.5, 15]);

      const satisfactionScale = satisfactionSlider.colorScale;
      const attributeToSlider = {
        Year: timeSlider,
        Salary: salarySlider, //this is a curveSlider
        "Inflation Adjusted Salary": salarySlider,
        "Job Satisfaction": satisfactionSlider,
        "Firm Type": firmtypeSlider,
        "Firm Size": firmsizeSlider,
        Age: ageSlider,
        "Years of Experience": yearsOfExperienceSlider,
        Licensed: licensedSlider,
        Gender: genderSlider,
        //below are searchBar objects
        "Job Title": jobTitleSearchBar,
        Location: locationSearchBar,
        "Undergraduate School": ugSearchBar,
        "Graduate School": gradSearchBar,
      };

      const colorScales = {};
      const histogramSliders = [];

      Object.keys(attributeToSlider).forEach((key) => {
        const slider = attributeToSlider[key];
        if (slider instanceof ClickableHistogramSlider) {
          colorScales[key] = slider.colorScale;
          histogramSliders.push(slider);
        }
      });

      const colorScalesHexbin = {
        "Job Satisfaction": BuOrColorInterpolator,
        "Salary": d3.interpolateGnBu,
        "Inflation Adjusted Salary": d3.interpolateGnBu, //same as Salary
        "percentageLicensed": d3.interpolateBlues,
        "percentageFemale": d3.interpolateRgb("#3ca951", "#ff8ab7"),
        "firmTypeMode": colorScales["Firm Type"],
        "firmSizeMode": colorScales["Firm Size"],
      };

      //individual map
      //setting up params and functions to handle canvas resizing
      let collapsed = false;
      const collapsedSidebarWidth = 20;
      const expandedSidebarWidth = 330;
      const buffer = 50; //rem
      function calcCanvasWidth() {
        // console.log("window.innerWidth", window.innerWidth)
        // console.log("screen.width", screen.width)

        //if it's too small then
        if (screen.width < 750) {
          console.log(
            "phone: individuanl map width",
            window.innerWidth - buffer
          );
          return window.innerWidth - buffer;
        }

        return (
          window.innerWidth -
          buffer -
          (collapsed ? collapsedSidebarWidth : expandedSidebarWidth)
        );
      }

      const individualMap = new IndividualMap(
        "canvasContainer",
        calcCanvasWidth(),
        data,
        salaryScale,
        colorScales,
        filters
      );
      d3.select("div#canvasContainer")
        .style("width", individualMap.width)
        .style("height", individualMap.height);

      //initiate texts
      d3.select("h2#medianSalary").text(
        d3.format("$,")(d3.median(data, (d) => d["Salary"]))
      );
      d3.select("h2#meanSatisfaction").text(
        d3.format(".2f")(d3.mean(data, (d) => d["Job Satisfaction"]))
      );
      d3.select("h2#numResponses").text(d3.format(",")(data.length));
      d3.select("p#numResponsesTotal").text(
        `/${d3.format(",")(data.length)} responses (100%)`
      );

      //set up the div width and button for sidebar collapse
      d3.select("div.aside").style("width", expandedSidebarWidth);
      d3.select("button#sidebarcollapse").on("click", (event) => {
        collapsed = !collapsed;

        if (collapsed) {
          //change sidebar width
          d3.select("div.aside")
            .style("width", collapsedSidebarWidth)
            .style("overflow", "hidden");

          //change toggle properties
          d3.selectAll("div.aside button.collapse span")
            .style("opacity", 0)
            .style("visibility", "hidden");

          //change filters visibility
          d3.select("div.sidebar")
            .style("opacity", 0)
            .style("visibility", "hidden");

          d3.select("button#sidebarcollapse i").style("rotate", "180deg");

          resizeCanvas();
        } else {
          //change sidebar width
          d3.select("div.aside")
            .style("width", expandedSidebarWidth)
            .style("overflow-y", "scroll");

          //change toggle properties
          d3.selectAll("div.aside button.collapse span")
            .style("opacity", 1)
            .style("visibility", "visible");

          //change filters visibility
          d3.select("div.sidebar")
            .style("opacity", 1)
            .style("visibility", "visible");
          d3.select("button#sidebarcollapse i").style("rotate", "0deg");

          resizeCanvas();
        }
      });

      //set up buttons that contain
      d3.select("button.filters i").style("rotate", "90deg"); //this is not collapsed
      let buttons = [
        { className: "customize", collapsed: true, display: "flex" },
        { className: "filters", collapsed: false, display: "block" },
      ];
      buttons.forEach((button) => {
        d3.select(`button.${button.className}`).on("click", (event) => {
          button.collapsed = !button.collapsed;
          d3.select(`button.${button.className} i`).style(
            "rotate",
            button.collapsed ? "0deg" : "90deg"
          );
          d3.selectAll(`div.${button.className}`).style(
            "display",
            button.collapsed ? "none" : button.display
          );
        });
      });

      //default coloring is by Job Satisfaction
      satisfactionSlider.updateColor(true);

      //set up clear all button
      let clearAllButton = d3.select("button.clear-all-filters");

      clearAllButton.on("click", (event) => {

        Object.keys(filters).forEach((key) => {
          if (filters[key] !== "d => true") {
            attributeToSlider[key].clearFilters();
          }
        }
        );

        //hide this clear all button
        clearAllButton.style("visibility", "hidden");
      });

      d3.select("select.sortOrder").on("change", function () {
        //console.log("updating sort order to", this.value);
        if (this.value == "Salary") {
          individualMap.updateSortOrder(adjustInflation ? "Inflation Adjusted Salary" : this.value);
        } else {
          individualMap.updateSortOrder(this.value);
        }

      });

      //map related scales and set up
      const states = await d3.json("data/cb_2023_us_state_5m.json");
      const stateMesh = topojson.mesh(
        states,
        states.objects.cb_2023_us_state_5m
      );

      let hexbinMap = new HexbinMap("hexbinMap", data, stateMesh, colorScalesHexbin);


      //LEGENDS
      //set up the legends in all the sliders
      histogramSliders.forEach((slider) => {
        slider.setupLegend(controlWidth, 8);
      });

      let collapsibleLegend = d3.select("div#collapsibleLegend");

      let hexBinSizeScaleNode;

      function updateHexBinSizeScaleNode() {
        hexBinSizeScaleNode = hexbinMap.hexBinSizeScale.node().cloneNode(true);
        //change the visibility to visible
        hexBinSizeScaleNode.style.visibility = "visible";
        hexBinSizeScaleNode.style.position = "relative";
      }

      updateHexBinSizeScaleNode();
      const legend = new CollapsibleLegend(
        collapsibleLegend,
        "number of responses",
        hexBinSizeScaleNode,
        "Job Satisfaction",
        satisfactionSlider.getLegendNode(),
        "Mean Job Satisfaction",
        Legend(hexbinMap.color, { width: 250, marginTop: 0, height: 30, tickValues: hexbinMap.color.ticks(6), tickFormat: d3.format(".2s") }),
        salaryScale
      );

      //color scale dropdown
      d3.select("select.colorScale").on("change", function () {
        individualMap.updateColors(this.value);

        histogramSliders.forEach((slider) => {
          if (slider.attribute == this.value) {
            slider.updateColor(true);
            slider.changeCollapsed(false); //open it up
            legend.updateColorScale(this.value, slider.getLegendNode());
          } else {
            slider.updateColor(false);
          }
        });
      });

      let hexSelectValueTitleMap = {
        "Job Satisfaction": "Mean Job Satisfaction",
        "Salary": "Median Salary",
        "percentageFemale": "% Female",
        "percentageLicensed": "% Licensed",
        "firmTypeMode": "Most Common Firm Type",
        "firmSizeMode": "Most Common Firm Size",
        "length": "Number of Responses"
      };
      //set up the hexbin customize dropdowns
      let colorScaleHexbinAttribute = "Job Satisfaction";

      function updateColorScaleHexbin(colorScaleHexbinAttribute) {
        if (colorScaleHexbinAttribute == "firmTypeMode") {
          legend.updateColorScaleHex(hexSelectValueTitleMap[colorScaleHexbinAttribute], firmtypeSlider.getLegendNode());
        } else if (colorScaleHexbinAttribute == "firmSizeMode") {
          legend.updateColorScaleHex(hexSelectValueTitleMap[colorScaleHexbinAttribute], firmsizeSlider.getLegendNode());
        } else {
          const tickFormat =
            colorScaleHexbinAttribute == "percentageFemale" || colorScaleHexbinAttribute == "percentageLicensed" ? d3.format(".0%")
              : colorScaleHexbinAttribute == "Salary" ? d3.format("$.2s")
                : d3.format(".2s");

          legend.updateColorScaleHex(hexSelectValueTitleMap[colorScaleHexbinAttribute], Legend(hexbinMap.color, { width: 250, marginTop: 0, height: 30, tickValues: hexbinMap.color.ticks(6), tickFormat: tickFormat }));
        }
      }

      d3.select("select.colorScaleHexbin").on("change", function () {
        hexbinMap.updateColorAttribute(this.value);

        colorScaleHexbinAttribute = this.value;
        //update collapsible legend
        updateColorScaleHexbin(colorScaleHexbinAttribute);
      });

      let sizeScaleHexbinTitle = "number of responses";

      d3.select("select.sizeScaleHexbin").on("change", function () {
        sizeScaleHexbinTitle = hexSelectValueTitleMap[this.value];

        hexbinMap.updateSizeAttribute(this.value);
        updateHexBinSizeScaleNode();

        legend.updateSizeScaleHex(sizeScaleHexbinTitle, hexBinSizeScaleNode);
      });


      let showIndMap = true;

      //add resizing function, if checkChange is false then always do updates (use for when indMap view is switched)
      let prevCanvasWidth = 0;
      function resizeCanvas(checkChange = true) {

        let currCanvasWidth = calcCanvasWidth();

        if (checkChange && currCanvasWidth == prevCanvasWidth) {
          return; //return if no change
        }

        if (showIndMap) {
          individualMap.updateWidth(calcCanvasWidth());
          d3.select("div#canvasContainer")
            .style("width", individualMap.width)
            .style("height", individualMap.height);
          d3.select("div.summaryContainer").style("width", individualMap.width);
        } else {
          d3.select("div.summaryContainer").style("width", currCanvasWidth);

          //also scale hex size legend
          const svgElement = document.querySelector("#hexbinMapSVG"); // Select your SVG element
          // console.log("svgElement", svgElement);
          // console.log("svgElement.getBoundingClientRect().width", svgElement.getBoundingClientRect().width);
          const scale = svgElement.getBoundingClientRect().width / hexbinMap.widthMap;
          // console.log("scale percentage", scale);

          legend.scaleSizeScaleHex(scale);
        }

        prevCanvasWidth = currCanvasWidth;

      }
      window.addEventListener("resize", resizeCanvas);

      let initialSwitch = true;
      let mainContainer = document.getElementById("mainContainer");
      d3.select("button#toggleIndMap").on("click", (event) => {

        showIndMap = !showIndMap;

        //styles on the toggle button
        d3.select("button#toggleIndMap span").text(showIndMap ? "View Map" : "View Individuals");
        d3.select("#toggleHexagon").style("display", showIndMap ? "block" : "none");
        d3.select("#toggleCircle").style("display", showIndMap ? "none" : "block");

        if (showIndMap) {
          //display right map
          d3.select("div#hexbinMap").style("display", "none");
          d3.select("div#canvasContainer").style("display", "block");
          //display properties
          d3.selectAll("div.indMapCustomize").style("display", "flex");
          d3.selectAll("div.hexbinCustomize").style("display", "none");

          //correct height property (better scrolling experience)
          mainContainer.classList.add("min-height-view");
          mainContainer.classList.remove("height-view");

          //showColors on slider
          //should this automatically expand it?
          const colorScaleValue = d3.select("select.colorScale").property("value");
          histogramSliders.forEach((slider) => {
            if (slider.attribute == colorScaleValue) {
              slider.updateColor(true);
              slider.changeCollapsed(false); //open it up
            } else {
              slider.updateColor(false);
            }
          });

          //sync attribute if it has since changed
          if (individualMap.adjustInflation != adjustInflation) {
            //only change attribute but don't update, since update is called below
            individualMap.toggleInflation(adjustInflation, false);
          }

          //update
          individualMap.update();
        } else {
          // Actions when `showIndMap` is false
          d3.select("div#hexbinMap").style("display", "flex");
          d3.select("div#canvasContainer").style("display", "none");

          d3.selectAll("div.indMapCustomize").style("display", "none");
          d3.selectAll("div.hexbinCustomize").style("display", "flex");
          mainContainer.classList.add("height-view");
          mainContainer.classList.remove("min-height-view");

          //hide colors on sliders
          histogramSliders.forEach((slider) => {
            slider.updateColor(false);
          });

          if (hexbinMap.adjustInflation != adjustInflation) {
            hexbinMap.toggleInflation(adjustInflation);
          }

          hexbinMap.updateData(passingData);

          //update the legends
          updateHexBinSizeScaleNode();
          legend.updateSizeScaleHex(sizeScaleHexbinTitle, hexBinSizeScaleNode);
          updateColorScaleHexbin(colorScaleHexbinAttribute);
        }

        //display correct legend info
        legend.toggleIndMap(showIndMap);

        //run resiveCanvas
        resizeCanvas(false);
        //TODO: less hacky way of correcting hex size scale, please
        if (initialSwitch) {
          initialSwitch = false;
          updateData();
        }
      });

      //function for updating summary (median income, mean sat, and # of responses)
      function updateSummary() {
        const medianSalary = d3.median(passingData, (d) => d[adjustInflation ? "Inflation Adjusted Salary" : "Salary"]);
        const meanSatisfaction = d3.mean(
          passingData,
          (d) => d["Job Satisfaction"]
        );

        if (passingData.length > 0) {
          //show summary
          d3.select("div.emptySummary").style("display", "none");
          d3.select("div.summaryAll").style("display", "flex");
          d3.select("h2#medianSalary").text(d3.format("$,")(medianSalary));
          d3.select("h2#meanSatisfaction").text(
            d3.format(".2f")(meanSatisfaction)
          );
          d3.select("h2#numResponses").text(d3.format(",")(passingData.length));
          d3.select("p#numResponsesTotal").text(
            `/${d3.format(",")(data.length)} responses (${d3.format(".0%")(
              passingData.length / data.length
            )})`
          );
        } else {
          d3.select("div.summaryAll").style("display", "none");
          d3.select("div.emptySummary").style("display", "block");
        }
      }

      //update data
      function updateData() {
        //filter for passing data
        passingData = data.filter(pointPassesFilters);

        //update sliders
        salarySlider.update();
        histogramSliders.forEach((slider) => {
          slider.update();
        });

        // Check if there are non-identity functions in filters, if yes then show clear all button
        const hasNonIdentityFilters = d3
          .selectAll("button.clear-filters")
          .nodes()
          .some(
            (button) => d3.select(button).style("visibility") === "visible"
          );
        clearAllButton.style(
          "visibility",
          hasNonIdentityFilters ? "visible" : "hidden"
        );

        updateSummary();


        if (showIndMap) {
          individualMap.update();
        } else {
          hexbinMap.updateData(passingData);

          updateHexBinSizeScaleNode();
          legend.updateSizeScaleHex(sizeScaleHexbinTitle, hexBinSizeScaleNode);

          updateColorScaleHexbin(colorScaleHexbinAttribute);
        }

      }

      resizeCanvas(false);
      updateData();

    };

    loadIndividuals();

    //set ups for desktop/mobile
    if (window.innerWidth > 768) {
      //set div.aside to have opacity 1 if screen is large
      d3.select("div.aside")
        .style("opacity", 1)
        .style("transform", "scale(1)");
    } else {
      //hide hexbinMap controls for mobile
      //TODO: bring this back when there's mobile support
      d3.select("div#toggleIndMapContainer").style("display", "none");
    };

    //monitoring scroll position to make aside sticky
    document.addEventListener("scroll", () => {
      const aside = document.querySelector("div.aside");
      const headingBottom = document.querySelector("div.heading").getBoundingClientRect().bottom;
      const isMobile = true;
      //window.innerWidth <= 768;  // Adjust for mobile breakpoint

      if (headingBottom <= 0) {
        // If the heading is out of view, make aside sticky
        aside.classList.add("sticky");

        // Apply fade-in animation for mobile devices
        if (isMobile) {
          aside.classList.add("visible");  // Trigger the fade-in and pop-up effect
        }
      } else {
        // Reset aside to its original position and remove animation class
        aside.classList.remove("sticky");

        // Apply fade-in animation for mobile devices
        if (isMobile) {
          aside.classList.remove("visible");  // Trigger the fade-in and pop-up effect
        }
      }
    });

  </script>
</body>

</html>
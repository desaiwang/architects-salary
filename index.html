<html>

<head>
  <title>Architect's Salary</title>
  <link rel="icon" type="image/svg+xml" href="/desai_icon.svg" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">
  <link href="./style.css" rel="stylesheet" type="text/css">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/d3-tile@1"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/d3-hexbin@0.2"></script>

</head>

<body>
  <div style="margin-top:30px">
  </div>



  <div>
    <!-- <div id="hexbinMap">
    </div> -->

    <div id="container" style="display: flex;">
      <div class="aside" style="overflow-y:scroll; overflow-x: hidden;">
        <div class="sidebar" style="display: flex; flex-direction: column;">

          <button data-resize-btn id="sidebarcollapse" class="collapse">
            <i class="bx bx-chevron-right"></i>
            <span style="font-weight:600;">Collapse</span>
          </button>

          <div id="filters">
            <div id="colorScaleDropdown" style="display:flex; 
            flex-direction:column;">
              <div style="margin-bottom:10px">Color by: &nbsp</div>
              <select id="colorScaleSelect">
                <option value="Year">Year</option>
                <option value="Job Satisfaction" selected>Job Satisfaction</option>
                <option value="Firm Type">Firm Type</option>
                <option value="Firm Size">Firm Size</option>
                <option value="Age">Age</option>
                <option value="Years of Experience">Years of Experience</option>
              </select>
            </div>

            <div id="controlfilterTime" class="filter"></div>
            <div id="controlfilterSalary" class="filter"></div>
            <div id="controlfilterSatisfaction" class="filter"></div>
            <div id="controlfilterFirmType" class="filter"></div>
            <div id="controlfilterFirmSize" class="filter"></div>
            <div id="controlfilterAge" class="filter"></div>
            <div id="controlfilterYearsOfExperience" class="filter"></div>
            <!-- <div id="controlfilterAnnualBonus"></div>
            <div id="controlfilterVacationDays"></div> -->
            <div id="searchLocation" class="filter"></div>
            <div id="searchUG" class="filter"></div>
            <div id="searchGrad" class="filter"></div>

            <div id="checkboxLicensed"></div>
            <div id="checkboxGender"></div>
            <div id="collapsibleLegend"></div>
            <div id="testLegend" height="100"></div>
          </div>
        </div>
      </div>

      <div class="main">
        <div id="header">
          <!-- style="margin-left:-100px" -->
          <h2 style="text-align: center"> Visualizing Architect's Salary in the US</h2>
          <h5 style="text-align: center; margin-top: -65px; margin-bottom: 50px"> Desai Wang</h5>
        </div>
        <div style="display: flex; margin-left:2rem">
          <h2 id="summaryText"></h2>
        </div>
        <div id="canvasContainer" style="width:1100px; height:1100px; position:relative; margin: 0 auto">
        </div>
        <!-- <div id="vizContainer" style="background-color: brown;">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis dictum, leo quis consequat semper, sem quam
          dapibus elit, vel auctor arcu ante ut purus. Cras luctus leo rhoncus ipsum luctus, non vestibulum turpis
          tempus.
          Etiam luctus suscipit tristique. Phasellus in viverra nulla. Suspendisse suscipit dignissim nulla, vitae
          sagittis est. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas.
          Nam
          tellus augue, auctor eu justo vel, rutrum euismod eros. Proin lorem dolor, vehicula ac laoreet vitae,
          malesuada
          a leo. Suspendisse potenti. Curabitur sed vehicula eros. Ut suscipit neque ut vehicula fringilla. Nam auctor
          neque urna, dapibus aliquam mauris fermentum ut. Nam convallis nibh urna, sed efficitur velit convallis ut.
        </div> -->


      </div>

    </div>
  </div>
  </div>

  </div>
  <div style="margin-bottom:100"></div>
  </div>

  <script type="module">

    import { hexbinMap } from './js/hexbinMap.js';
    import { geoAlbersUsaPr } from "./js/geoAlbersUsaPr.js";
    import ClickableHistogramSlider from './js/clickableHistogramSlider.js';
    import CurveSlider from './js/curveSlider.js';
    import IndividualMap from './js/individualMap.js';
    import SearchBar from './js/searchBar.js';
    import Checkboxes from './js/checkboxes.js';
    import CollapsibleLegend from './js/collapsibleLegend.js';


    //set up for map
    const widthMap = 928;
    const heightMap = 581;
    // Create the container SVG for map
    const svgMap = d3.select("div#hexbinMap")
      .append("svg")
      .attr("viewBox", [0, 0, widthMap, heightMap])
      .attr("width", widthMap)
      .attr("height", heightMap)
      .attr("style", "max-width: 100%; height: auto;");
    const mapArea = svgMap.append("g");



    const loadIndividuals = async function () {
      let data = await d3.csv("data/241102_archinect_salaries_fulltime.csv", d3.autoType);
      console.log(data);
      data.forEach(d => {
        if (d['Firm Type'] == null) {
          d['Firm Type'] = "N/A";
        }
      });

      //filter used for updates
      var filters = {};

      function pointPassesFilters(point) {

        let stillPassed = true;

        Object.values(filters).forEach(filterFunc => {
          stillPassed = filterFunc(point) && stillPassed;
        });

        return stillPassed;
      }


      //sets up contols
      let controlWidth = 270;
      let controlHeight = 60;

      let controlSalary = d3.select("#controlfilterSalary");
      // function getButtonDataSalary(attribute, values) {
      //   return [
      //     { label: "> $50k", filterFunc: d => d[attribute] > 50000 },
      //     { label: "> $100k", filterFunc: d => d[attribute] > 100000 },
      //     { label: "top 20 incomes", filterFunc: d => d[attribute] >= values[19] }
      //   ];
      // }

      let salarySlider = new CurveSlider(data, controlSalary, "Salary", "Salary", controlWidth, controlHeight, updateData, filters, {
        maxLimit: 200000, scaleFormatter: d => d === 0 ? "$0" : d3.format("$.2s")(d),
        //getButtonData: getButtonDataSalary 
      });

      // let controlAnnualBonus = d3.select("#controlfilterAnnualBonus");
      // let annualBonusSlider = new CurveSlider(data, controlAnnualBonus, "Annual Bonus", "Annual Bonus", controlWidth, controlHeight, updateData, filters, { maxLimit: 50000, scaleFormatter: d => d === 0 ? "$0" : d3.format("$.2s")(d) });

      // let controlVacationDays = d3.select("#controlfilterVacationDays");
      // let vacationDaysSlider = new CurveSlider(data, controlVacationDays, "Vacation Days", "Vacation Days", controlWidth, controlHeight, updateData, filters, { maxLimit: 40 });

      let controlTime = d3.select("#controlfilterTime");
      const timeSlider = new ClickableHistogramSlider(data, controlTime, "Survey Year", "Year", controlWidth, controlHeight, updateData, filters, { colorInterpolator: d3.interpolateGreys, colorInterpolationType: "sequential discrete", fontsize: '0.5rem' });

      let controlSatisfaction = d3.select("#controlfilterSatisfaction");
      const BuOrColorInterpolator = d3.piecewise(d3.interpolateRgb, ['#0a1869', '#a9c9e7', "#ffe3a8", '#fc6f03']);
      const satisfactionSlider = new ClickableHistogramSlider(data, controlSatisfaction, "Job Satisfaction", "Job Satisfaction", controlWidth, controlHeight, updateData, filters, { colorInterpolator: BuOrColorInterpolator, colorInterpolationType: "sequential continuous" });

      let controlFirmType = d3.select("#controlfilterFirmType");
      const firmtypeSlider = new ClickableHistogramSlider(data, controlFirmType, "Firm Type", "Firm Type", controlWidth, controlHeight, updateData, filters, { colorInterpolationType: "categorical", colorScheme: ['#6cc5b0', '#4269d0', '#ff8ab7', '#efb118', '#3ca951', '#ff725c', '#a463f2', '#97bbf5', '#9c6b4e', '#9498a0'], sortOrder: ["Boutique", "Corporate", "Individual", "Starchitect", "Other", "N/A"], fontsize: '0.5rem' });

      let controlFirmSize = d3.select("#controlfilterFirmSize");
      const firmsizeSlider = new ClickableHistogramSlider(data, controlFirmSize, "Firm Size", "Firm Size", controlWidth, controlHeight, updateData, filters, { colorInterpolator: d3.interpolateGnBu, colorInterpolationType: "sequential discrete", sortOrder: [1, "2-5", "6-10", "11-15", "16-30", "31-50", "51-100", "101-200", "201-500", "501+"], rotateAxisLabels: true });


      let controlAge = d3.select("#controlfilterAge");
      const ageSlider = new ClickableHistogramSlider(data, controlAge, "Age", "Age", controlWidth, controlHeight, updateData, filters, { colorInterpolator: d3.interpolatePuRd, colorInterpolationType: "sequential discrete", sortOrder: ["18-20", "21-25", "26-30", "31-35", "36-40", "41-45", "46-50", "51-55", "56-60", "61-65", "66-70", "71-103"], rotateAxisLabels: true });


      let controlYearsOfExperience = d3.select("#controlfilterYearsOfExperience");
      const yearsOfExperienceSlider = new ClickableHistogramSlider(data, controlYearsOfExperience, "Years of Experience", "Years of Experience", controlWidth, controlHeight, updateData, filters, {
        colorInterpolator: d3.interpolatePuRd, colorInterpolationType: "sequential discrete", sortOrder: ["< 1", 1, 2, 3, "3-5", "6-7", "8-10", "11-15", "16-20", "21-25", "26-30", "31-40",
          "> 40"
        ], rotateAxisLabels: true
      });

      const firmTypeScale = d3.scaleOrdinal().domain(["Boutique", "Corporate", "Individual", "Starchitect", "Other", "N/A"]).range(d3.schemeTableau10);

      //search bars
      let searchLocation = d3.select("div#searchLocation")
      const locationSearchBar = new SearchBar(searchLocation, "Location", filters, updateData);

      let searchUG = d3.select("div#searchUG")
      const ugSearchBar = new SearchBar(searchUG, "Undergraduate School", filters, updateData);

      let searchGrad = d3.select("div#searchGrad")
      const gradSearchBar = new SearchBar(searchGrad, "Graduate School", filters, updateData);

      let checkboxLicensed = d3.select("div#checkboxLicensed")
      const licensedCheckbox = new Checkboxes(checkboxLicensed, "Licensed",
        [{
          "label": "Yes",
          "attributeVal": "Licensed"
        }, {
          "label": "No",
          "attributeVal": "No"
        }],
        filters, updateData);

      let checkboxGender = d3.select("div#checkboxGender")
      const genderCheckbox = new Checkboxes(checkboxGender, "Gender",
        [{
          "label": "Female",
          "attributeVal": "Female"
        }, {
          "label": "Male",
          "attributeVal": "Male"
        },
        {
          "label": "Other",
          "attributeVal": "Other"
        }],
        filters, updateData);

      //scales
      const salaryExtent = d3.extent(data, d => d['Salary'])
      const salaryScale = d3.scaleSqrt().domain(salaryExtent).range([0.5, 15])

      const satisfactionScale = satisfactionSlider.colorScale;
      const colorScales = {
        "Year": timeSlider.colorScale,
        "Job Satisfaction": satisfactionSlider.colorScale,
        "Firm Type": firmtypeSlider.colorScale,
        "Firm Size": firmsizeSlider.colorScale,
        "Age": ageSlider.colorScale,
        "Years of Experience": yearsOfExperienceSlider.colorScale
      }

      //default coloring is by Job Satisfaction
      satisfactionSlider.updateColor(true);
      const individualMap = new IndividualMap("canvasContainer", data, salaryScale, colorScales, filters);

      //listener for color scale change
      const sliders = [timeSlider, satisfactionSlider, firmtypeSlider, firmsizeSlider, ageSlider, yearsOfExperienceSlider];

      //set up the legends in all the sliders
      sliders.forEach(slider => {
        slider.setupLegend(controlWidth - 25, 8);
      });

      //legend
      let collapsibleLegend = d3.select("div#collapsibleLegend")
      const legend = new CollapsibleLegend(collapsibleLegend, "Job Satisfaction", satisfactionSlider.getLegendNode());

      //color scale dropdown
      d3.select("select#colorScaleSelect")
        .on("change", function () {
          individualMap.updateColors(this.value);

          sliders.forEach(slider => {
            if (slider.attribute == this.value) {
              slider.updateColor(true)
              slider.changeCollapsed(false); //open it up
              legend.updateColorScale(this.value, slider.getLegendNode());
            }
            else { slider.updateColor(false) };
          });
        });


      //map related scales and set up
      const states = await d3.json("data/cb_2023_us_state_5m.json");
      const stateMesh = topojson.mesh(states, states.objects.cb_2023_us_state_5m);

      const projection = geoAlbersUsaPr().scale(4 / 3 * widthMap).translate([widthMap / 2, heightMap / 2]);

      // // Append the state mesh.
      // mapArea.append("path")
      //   .datum(stateMesh)
      //   .attr("fill", "none")
      //   .attr("stroke", "#777")
      //   .attr("stroke-width", 0.5)
      //   .attr("stroke-linejoin", "round")
      //   .attr("d", d3.geoPath(projection));
      // //set up the layer used for hexBin rendering
      // let hexBinLayer = mapArea.append("g");


      function updateData() {
        //filter for passing data
        const passingData = data.filter(pointPassesFilters);
        const passingDataSize = passingData.length;
        //console.log("passingDataSize", passingDataSize)

        //update sliders
        timeSlider.update();
        // annualBonusSlider.update();
        // vacationDaysSlider.update();

        salarySlider.update();
        satisfactionSlider.update();
        firmtypeSlider.update();
        firmsizeSlider.update();
        ageSlider.update();
        yearsOfExperienceSlider.update();



        //hexbinMap(projection, passingData, "satisfaction", "length", hexBinLayer, widthMap, heightMap);


        const medianSalary = d3.median(passingData, d => d['Salary']);
        const meanSatisfaction = d3.mean(passingData, d => d['Job Satisfaction']);

        d3.select("h2#summaryText")
          .text(passingDataSize > 0 ? `Showing ${d3.format(",")(passingDataSize)} out of ${d3.format(",")(data.length)} individuals. Median Salary: ${d3.format("$,")(medianSalary)}, Mean Satisfaction: ${d3.format(".2f")(meanSatisfaction)}/10` : "No data selected")

        individualMap.update();

      }



      let collapsed = false;
      d3.select("button#sidebarcollapse")
        .on("click", (event) => {
          collapsed = !collapsed;

          if (collapsed) {
            //change sidebar width
            d3.select("div.aside").style("width", "2rem")
              .style("overflow", "hidden");

            //change toggle properties
            d3.select("div.sidebar button span")
              .style("opacity", 0)
              .style("visibility", "hidden");

            //change filters visibility
            d3.select("div#filters")
              .style("opacity", 0)
              .style("visibility", "hidden");

            d3.select(".bx.bx-chevron-right").style("rotate", "180deg")

            individualMap.updateWidth(1300, 1000);
          } else {
            //change sidebar width
            d3.select("div.aside").style("width", "21rem")
              .style("overflow-y", "scroll");

            //change toggle properties
            d3.select("div.sidebar button span")
              .style("opacity", 1)
              .style("visibility", "visible");

            //change filters visibility
            d3.select("div#filters")
              .style("opacity", 1)
              .style("visibility", "visible");
            d3.select(".bx.bx-chevron-right").style("rotate", "0deg")

            individualMap.updateWidth(1100, 1100);
          }
        });

    }

    loadIndividuals();

    //this is d3 stock example
    // d3.select("div#hexbinMap").node().appendChild(await hexbinMap());

  </script>
</body>

</html>